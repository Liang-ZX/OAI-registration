

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>Segmentation &#8212; pyKNEEr 1.0.0 documentation</title>
    <link rel="stylesheet" href="_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/css/custom.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Morphology" href="morphology.html" />
    <link rel="prev" title="Preprocessing" href="preprocessing.html" />
  
  
  
   


  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="morphology.html" title="Morphology"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="preprocessing.html" title="Preprocessing"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pyKNEEr 1.0.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar"><!--
The following code is the original from the template
It writes a text at the top of the side bar that links to the home page

<a href="
    index.html" class="text-logo">pyKNEEr</a>
-->


<!--
This line add a figure at the top of the left side bar that links to the home page
The figure has to be in the folder "build" (not in the subfolder "html")
(I could not make the relative path to the folders "_figure" in "source" and "_images" in "build" work)
-->

<a href="index.html"><img src="pykneer_logo_for_website.png" style="width:253px;height:78px;"></a>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <!--<h2>Table Of Contents</h2> --> <!-- Modified by S.Bonaretti -->
  </div>
  <div class="sidebar-toc">
    
    
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="preprocessing.html">Preprocessing</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Segmentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#new-subject">New subject</a></li>
<li class="toctree-l2"><a class="reference internal" href="#multimodal">Multimodal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#longitudinal">Longitudinal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#segmentation-plus">Segmentation Plus</a></li>
<li class="toctree-l2"><a class="reference internal" href="#finding-reference-image">Finding reference image</a></li>
<li class="toctree-l2"><a class="reference internal" href="#segmentation-quality">Segmentation quality</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="morphology.html">Morphology</a></li>
<li class="toctree-l1"><a class="reference internal" href="relaxometry.html">Relaxometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>

    
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          <!-- # Commented out by S.Bonaretti - to avoid docs >> index etc.
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="index.html">Docs</a></li>
              
              <li>Segmentation</li>
            </ol>
          </div>
          -->
          <div class="document clearer body">
            
  <div class="section" id="segmentation">
<span id="id1"></span><h1>Segmentation<a class="headerlink" href="#segmentation" title="Permalink to this headline">¶</a></h1>
<p><em>pyKNEEr</em> computes <strong>atlas-based segmentation</strong>, which is based on <strong>registration</strong>, using <em>elastix</em> [1].
In registration there are a <strong>reference</strong> (or target) image and a <strong>moving</strong> (or floating) image, which is warped to the reference image.
The reference image is already segmented, whereas the moving image has to be segmented.</p>
<p>In <em>pyKNEEr</em>, atlas-based segmentation has three steps:</p>
<ol class="arabic simple">
<li><p>The moving image is registered to the reference image though transformations</p></li>
<li><p>The transformations are inverted</p></li>
<li><p>The inverted transformations are applied to the reference mask to obtain the moving mask</p></li>
</ol>
<p>These steps are applied:</p>
<ol class="arabic simple">
<li><p>To the <strong>femur</strong> to align the moving image to the reference image, and guide femoral cartilage segmentation</p></li>
<li><p>To the <strong>femoral cartilage</strong> to obtain the segmented image</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The current method does <strong>not</strong> take into account segmentation accuracy at the <strong>bone-cartilage interface</strong>.
The femur alignment is used to guide cartilage segmentation, and femur segmentation is a byproduct of the workflow.</p>
</div>
<p>In <em>pyKNEEr</em>, there are three segmentation modalities:</p>
<ul class="simple">
<li><p><strong>New subject</strong>: Segmentation of single images, baseline images in longitudinal studies, or high-resolution images in multimodal acquisitions</p></li>
<li><p><strong>Multimodal</strong>: Segmentation of images acquired with different protocols, where the highest resolution image has already been segmented as <em>new subject</em></p></li>
<li><p><strong>Longitudinal</strong>: Segmentation of followup images, where the baseline image has already been segmented as <em>new subject</em></p></li>
</ul>
<p>For the execution, the differences among the three modalities are:</p>
<ul class="simple">
<li><p>The <strong>reference image</strong></p></li>
<li><p>The structure of the <strong>input file</strong></p></li>
<li><p>The variable <code class="docutils literal notranslate"><span class="pre">modality</span></code> in <code class="docutils literal notranslate"><span class="pre">segmentation_sa.ipynb</span></code></p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="new-subject">
<span id="newsubject"></span><h2>New subject<a class="headerlink" href="#new-subject" title="Permalink to this headline">¶</a></h2>
<div class="section" id="reference-image">
<h3>Reference image<a class="headerlink" href="#reference-image" title="Permalink to this headline">¶</a></h3>
<p>The reference image is the same for all the images to be segmented</p>
<p>In the folder <code class="docutils literal notranslate"><span class="pre">reference</span></code>, the reference image is in the folder <code class="docutils literal notranslate"><span class="pre">newsubject</span></code>, which contains:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">reference.mha</span></code>: Reference image for the atlas-based segmentation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reference_f.mha</span></code>: Femur mask of the reference image</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reference_fc.mha</span></code>: Femoral cartilage mask of the reference image.</p></li>
</ul>
<p>This reference was found with a <a class="reference internal" href="#findreference"><span class="std std-ref">convergence study</span></a> on 19 segmented images</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When using <strong>your own data</strong>:</p>
<ul class="simple">
<li><p>You can use the same reference image contained in the demo dataset: copy the files <code class="docutils literal notranslate"><span class="pre">reference.mha</span></code>, <code class="docutils literal notranslate"><span class="pre">reference_f.mha</span></code>, and <code class="docutils literal notranslate"><span class="pre">reference_fc.mha</span></code> to your <code class="docutils literal notranslate"><span class="pre">reference/newsubject</span></code> folder</p></li>
<li><p>You can use a different reference image: copy your new reference image, femur mask, and femoral cartilage mask to the <code class="docutils literal notranslate"><span class="pre">reference/newsubject</span></code> folder, making sure you rename the files as <code class="docutils literal notranslate"><span class="pre">reference.mha</span></code>, <code class="docutils literal notranslate"><span class="pre">reference_f.mha</span></code>, and <code class="docutils literal notranslate"><span class="pre">reference_fc.mha</span></code></p></li>
<li><p>If you want to find a reference image from an already segmented dataset, you can run <em>pyKNEEr</em> <a class="reference internal" href="#findreference"><span class="std std-ref">convergence study</span></a></p></li>
</ul>
</div>
</div>
<div class="section" id="input-image-list">
<h3>Input: Image list<a class="headerlink" href="#input-image-list" title="Permalink to this headline">¶</a></h3>
<p>For the demo images, the input file is <code class="docutils literal notranslate"><span class="pre">image_list_newsubject.txt</span></code>, which contains:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">./</span><span class="n">reference</span><span class="o">/</span><span class="n">newsubject</span>
<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">./</span><span class="n">preprocessed</span><span class="o">/</span>
<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">r</span> <span class="n">reference</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="n">m</span> <span class="mo">01</span><span class="n">_DESS_01_prep</span><span class="o">.</span><span class="n">mha</span>
</pre></div>
</div>
<p>where:</p>
<ul class="simple">
<li><p>Line 1: Reference folder, containing the reference image and its masks</p></li>
<li><p>Line 2: Preprocessed file folder, containing the preprocessed files</p></li>
<li><p>Line 3: Reference image, indicated as <code class="docutils literal notranslate"><span class="pre">r</span></code></p></li>
<li><p>Line 4: Moving images, indicated as <code class="docutils literal notranslate"><span class="pre">m</span></code></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When using <strong>your own data</strong>:</p>
<ul class="simple">
<li><p>Customize <code class="docutils literal notranslate"><span class="pre">image_list_newsubject.txt</span></code> with the paths and the names of your images</p></li>
<li><p>There is no limit to the number of moving <code class="docutils literal notranslate"><span class="pre">m</span></code> images</p></li>
</ul>
</div>
</div>
<div class="section" id="executing-segmentation-sa-ns-ipynb">
<span id="execution"></span><h3>Executing segmentation_sa_ns.ipynb<a class="headerlink" href="#executing-segmentation-sa-ns-ipynb" title="Permalink to this headline">¶</a></h3>
<p>To segment the data:</p>
<ul class="simple">
<li><p><a class="reference internal" href="faq.html#launch-jup"><span class="std std-ref">Launch</span></a> Jupyter notebook</p></li>
<li><p>In <em>File Browser</em>, navigate to <code class="docutils literal notranslate"><span class="pre">segmentation_sa_ns.ipynb</span></code>, open it, and:</p>
<ul>
<li><p>Customize the input variable <code class="docutils literal notranslate"><span class="pre">n_of_cores</span></code> (<a class="reference internal" href="faq.html#cores"><span class="std std-ref">How do I choose the number of cores?</span></a>)</p></li>
<li><p>Notice that variable <code class="docutils literal notranslate"><span class="pre">modality</span></code> is set to <code class="docutils literal notranslate"><span class="pre">newsubject</span></code></p></li>
<li><p>Follow the instructions in the notebook</p></li>
</ul>
</li>
<li><p><a class="reference internal" href="faq.html#save-jup"><span class="std std-ref">Save</span></a> your notebook at the end of the process</p></li>
</ul>
</div>
<div class="section" id="output-segmented-images">
<span id="output"></span><h3>Output: Segmented images<a class="headerlink" href="#output-segmented-images" title="Permalink to this headline">¶</a></h3>
<p>The masks are in the folder <code class="docutils literal notranslate"><span class="pre">segmented</span></code>. For each subjects, the outputs are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">*_prep_fc.mha</span></code> (e.g. <code class="docutils literal notranslate"><span class="pre">01_DESS_01_prep_fc.mha</span></code>): Binary mask of the femoral cartilage</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">*_prep_f.mha</span></code> (e.g. <code class="docutils literal notranslate"><span class="pre">01_DESS_01_prep_f.mha</span></code>): Binary mask of the femur, a byproduct of the registration</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Intermediate registration steps are saved in the folder <code class="docutils literal notranslate"><span class="pre">registered</span></code></p>
<p>If you are not interested in analysis from deformations, you can delete the folder after your computations</p>
<p>If you want to compute further analysis, the folders <code class="docutils literal notranslate"><span class="pre">registered/subject_name</span></code> contain:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">fc_spline.mha</span></code> (intersubject and longitudinal segmentation) or <code class="docutils literal notranslate"><span class="pre">f_rigig.mha</span></code> (multimodal segmentation), which contain the moving image warped to the reference. They can be used for analysis such as voxel-based relaxometry</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TransformParameters.xxx.txt</span></code>, which contain transformation values. They can be used for PCA or other analysis. For their use, we forward to the <code class="docutils literal notranslate"><span class="pre">elastix</span></code> <a class="reference external" href="https://github.com/SuperElastix/elastix/wiki/What-is-elastix/">manual</a></p></li>
</ul>
</div>
</div>
<div class="section" id="visualization-superimposing-cartilage-mask-onto-the-mr-image">
<span id="visualization"></span><h3>Visualization: Superimposing cartilage mask onto the MR image<a class="headerlink" href="#visualization-superimposing-cartilage-mask-onto-the-mr-image" title="Permalink to this headline">¶</a></h3>
<p>For a qualitative check, for each subject we visualize three <strong>2D</strong> slices of the intensity image (<code class="docutils literal notranslate"><span class="pre">*_prep.mha</span></code>) overlapped by the corresponding slices of the cartilage mask (<code class="docutils literal notranslate"><span class="pre">*_prep_fc.mha</span></code>), similarly to this figure:</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="_images/newSubject.png"><img alt="_images/newSubject.png" src="_images/newSubject.png" style="width: 762.3000000000001px; height: 251.1px;" /></a>
</div>
<p>For a <strong>3D</strong> check, consider using a medical image software such as <a class="reference internal" href="faq.html#itksnap"><span class="std std-ref">ITK-SNAP</span></a>, which allows visualizing <a class="reference internal" href="faq.html#itksnapmask"><span class="std std-ref">the overlap of an image and its mask</span></a></p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="multimodal">
<h2>Multimodal<a class="headerlink" href="#multimodal" title="Permalink to this headline">¶</a></h2>
<div class="section" id="reference-image-the-corresponding-high-resolution-acquisition">
<h3>Reference image: The corresponding high-resolution acquisition<a class="headerlink" href="#reference-image-the-corresponding-high-resolution-acquisition" title="Permalink to this headline">¶</a></h3>
<p>For each acquisition at lower resolution (e.g. CubeQuant), the reference image is a high-resolution image of the same subject (e.g. DESS), which must have been previously <a class="reference internal" href="#newsubject"><span class="std std-ref">segmented</span></a> as a <code class="docutils literal notranslate"><span class="pre">newsubject</span></code>.</p>
<p>In the folder <code class="docutils literal notranslate"><span class="pre">reference</span></code>, create the folder <code class="docutils literal notranslate"><span class="pre">multimodal</span></code>, and copy:</p>
<ul class="simple">
<li><p>The high-resolution image: <code class="docutils literal notranslate"><span class="pre">01_DESS_01_prep.mha</span></code> from the folder <code class="docutils literal notranslate"><span class="pre">preprocessed</span></code></p></li>
<li><p>The high-resolution femur mask: <code class="docutils literal notranslate"><span class="pre">01_DESS_01_prep_f.mha</span></code> from the folder <code class="docutils literal notranslate"><span class="pre">segmented</span></code></p></li>
<li><p>The high-resolution femoral cartilage mask: <code class="docutils literal notranslate"><span class="pre">01_DESS_01_prep_fc.mha</span></code> from the folder <code class="docutils literal notranslate"><span class="pre">segmented</span></code></p></li>
</ul>
<p>This step will be simplified in future versions of <em>pyKNEEr</em></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When using <strong>your own data</strong>:</p>
<ul class="simple">
<li><p>In the folder <code class="docutils literal notranslate"><span class="pre">reference</span></code> create the folder <code class="docutils literal notranslate"><span class="pre">multimodal</span></code></p></li>
<li><p>Copy the high-resolution images to be used as a references, together with their femur mask and femoral cartilage mask</p></li>
</ul>
</div>
</div>
<div class="section" id="id2">
<h3>Input: Image list<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>For the demo images, the input file is <code class="docutils literal notranslate"><span class="pre">image_list_multimodal.txt</span></code>, which contains:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">./</span><span class="n">reference</span><span class="o">/</span><span class="n">multimodal</span>
<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">./</span><span class="n">preprocessed</span><span class="o">/</span>
<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">r</span> <span class="mo">01</span><span class="n">_DESS_01_prep</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="n">m</span> <span class="mo">01</span><span class="n">_cubeQuant_01_prep</span><span class="o">.</span><span class="n">mha</span>
</pre></div>
</div>
<p>where:</p>
<ul class="simple">
<li><p>Line 1: Reference folder, containing the baseline images used as reference</p></li>
<li><p>Line 2: Preprocessed file folder, containing the preprocessed images</p></li>
<li><p>Line 3: Reference (high res) image, indicated as <code class="docutils literal notranslate"><span class="pre">r</span></code></p></li>
<li><p>Line 4: Moving (low res) image, indicated as <code class="docutils literal notranslate"><span class="pre">m</span></code></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When using <strong>your own data</strong>:</p>
<ul class="simple">
<li><p>Customize <code class="docutils literal notranslate"><span class="pre">image_list_multimodal.txt</span></code> with the paths and the names of your images</p></li>
<li><p>In case of several images to segment, write high-resolution images <code class="docutils literal notranslate"><span class="pre">r</span></code> and low-resolution images <code class="docutils literal notranslate"><span class="pre">m</span></code> in a coupled manner:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">./</span><span class="n">reference</span><span class="o">/</span><span class="n">longitudinal</span>
<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">./</span><span class="n">preprocessed</span><span class="o">/</span>
<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">r</span> <span class="n">subject1_HRes_prep</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="n">m</span> <span class="n">subject1_LRes_prep</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="n">r</span> <span class="n">subject2_HRes_prep</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="n">m</span> <span class="n">subject2_LRes_prep</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="n">r</span> <span class="n">subject3_HRes_prep</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="n">m</span> <span class="n">subject3_LRes_prep</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="n">etc</span><span class="o">.</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="execution-output-and-visualization">
<h3>Execution, Output, and Visualization<a class="headerlink" href="#execution-output-and-visualization" title="Permalink to this headline">¶</a></h3>
<p>Execution:</p>
<ul class="simple">
<li><p>To segment the data, apply the <a class="reference internal" href="#execution"><span class="std std-ref">instructions</span></a> above to the notebook <code class="docutils literal notranslate"><span class="pre">segmentation_sa_mm.ipynb</span></code>. Note that the variable <code class="docutils literal notranslate"><span class="pre">modality</span></code> is set to <code class="docutils literal notranslate"><span class="pre">multimodal</span></code></p></li>
</ul>
<p>Output and visualization:</p>
<ul class="simple">
<li><p>Follow the instructions above to know the <a class="reference internal" href="#output"><span class="std std-ref">output</span></a> and how to <a class="reference internal" href="#visualization"><span class="std std-ref">visualize</span></a> the results</p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="longitudinal">
<h2>Longitudinal<a class="headerlink" href="#longitudinal" title="Permalink to this headline">¶</a></h2>
<p>For this segmentation modality, we do not provide a demo example but instructions as it is very similar to multimodal segmentation</p>
<div class="section" id="reference-image-the-corresponding-baseline-acquisition">
<h3>Reference image: The corresponding baseline acquisition<a class="headerlink" href="#reference-image-the-corresponding-baseline-acquisition" title="Permalink to this headline">¶</a></h3>
<p>For each <strong>followup</strong> image, the reference image is the corresponding <strong>baseline</strong> image, which must have been previously segmented as a <a class="reference internal" href="#newsubject"><span class="std std-ref">new subject</span></a></p>
<p>In the folder <code class="docutils literal notranslate"><span class="pre">reference</span></code>, create the folder <code class="docutils literal notranslate"><span class="pre">longitudinal</span></code>, and for each image copy:</p>
<ul class="simple">
<li><p>The baseline image: <code class="docutils literal notranslate"><span class="pre">BL_prep.mha</span></code></p></li>
<li><p>The baseline femur mask: <code class="docutils literal notranslate"><span class="pre">BL_prep_f.mha</span></code></p></li>
<li><p>The baseline femoral cartilage mask: <code class="docutils literal notranslate"><span class="pre">BL_prep_fc.mha</span></code></p></li>
</ul>
<p>This step will be simplified in future versions of <em>pyKNEEr</em>.</p>
</div>
<div class="section" id="id3">
<h3>Input: Image list<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>Create the file <code class="docutils literal notranslate"><span class="pre">image_list_longitudinal.txt</span></code>, which will contain:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">./</span><span class="n">reference</span><span class="o">/</span><span class="n">longitudinal</span>
<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">./</span><span class="n">preprocessed</span><span class="o">/</span>
<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">r</span> <span class="n">subject1_BL_prep</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="n">m</span> <span class="n">subject1_FU_prep</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="n">r</span> <span class="n">subject2_BL_prep</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="n">m</span> <span class="n">subject2_FU_prep</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="n">r</span> <span class="n">subject3_BL_prep</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="n">m</span> <span class="n">subject3_FU_prep</span><span class="o">.</span><span class="n">mha</span>
</pre></div>
</div>
<p>where:</p>
<ul class="simple">
<li><p>Line 1: Reference folder, containing the the baseline images used as reference</p></li>
<li><p>Line 2: Preprocessed file folder, containing the preprocessed files of the corresponding followup images</p></li>
<li><p>Odd lines from 3 to 7: Reference (baseline) images, indicated as <code class="docutils literal notranslate"><span class="pre">r</span></code></p></li>
<li><p>Even lines 4 to 8: Moving (followup) images, indicated as <code class="docutils literal notranslate"><span class="pre">m</span></code></p></li>
</ul>
</div>
<div class="section" id="id4">
<h3>Execution, Output, and Visualization<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Execution:</p>
<ul class="simple">
<li><p>To segment the data, apply the <a class="reference internal" href="#execution"><span class="std std-ref">instructions</span></a> above. Set the variable <code class="docutils literal notranslate"><span class="pre">modality</span></code> to <code class="docutils literal notranslate"><span class="pre">longitudinal</span></code></p></li>
</ul>
<p>Output and visualization:</p>
<ul class="simple">
<li><p>Follow the instructions above to know the <a class="reference internal" href="#output"><span class="std std-ref">output</span></a> and how to <a class="reference internal" href="#visualization"><span class="std std-ref">visualize</span></a> the results</p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="segmentation-plus">
<h2>Segmentation Plus<a class="headerlink" href="#segmentation-plus" title="Permalink to this headline">¶</a></h2>
<p><em>pyKNEEr</em> includes notebooks to find the reference image and evaluate segmentation quality</p>
<p>These two steps are not included in the demo for sake of simplicity</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="finding-reference-image">
<span id="findreference"></span><h2>Finding reference image<a class="headerlink" href="#finding-reference-image" title="Permalink to this headline">¶</a></h2>
<p>In this convergence study, the new reference is the image of the dataset whose vector field is the closest to the average of the vector fields of the dataset. The study runs until convergence or for a fixed amount of iterations</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To run this convergence study all the images of the dataset <strong>must already have</strong> a <strong>femur mask</strong></p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div>The Jupyter notebook to find a reference image is <a href="https://github.com/sbonaretti/pyKNEEr/blob/master/pykneer/notebooks/find_reference.ipynb" target="_blank">find_reference.ipynb</a></div></blockquote>
<div class="section" id="picking-random-seeds">
<h3>Picking random seeds<a class="headerlink" href="#picking-random-seeds" title="Permalink to this headline">¶</a></h3>
To determine the image that you are going to use as reference, we recommend a random generator function with a fixed seed to make the reference selection reproducible.
The code is
<a href="https://github.com/sbonaretti/pyKNEEr/tree/master/pykneer/pykneer/find_reference_random_gen.py" target="_blank">here</a>.
<p> </p>
You can run several convergence study in parallel to confirm you find the same reference image independently from the starting seed</div>
<div class="section" id="id5">
<h3>Input: Image list<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>Data required are MR images of the knee that have segmented femurs because: 1) the registration is guided by the femur mask; 2) the average vector field is calculated in the femur mask; and 3) the comparison between the average vector field and each image vector field is performed in the femur mask</p>
<p>In you data folder, create a folder called <code class="docutils literal notranslate"><span class="pre">findReference</span></code> and add the preprocessed images of the  dataset with their masks:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">subject1_prep</span><span class="o">.</span><span class="n">mha</span>
<span class="o">-</span> <span class="n">subject1_f</span><span class="o">.</span><span class="n">mha</span>
<span class="o">-</span> <span class="n">subject2_prep</span><span class="o">.</span><span class="n">mha</span>
<span class="o">-</span> <span class="n">subject2_f</span><span class="o">.</span><span class="n">mha</span>
<span class="o">-</span> <span class="n">subject3_prep</span><span class="o">.</span><span class="n">mha</span>
<span class="o">-</span> <span class="n">subject3_f</span><span class="o">.</span><span class="n">mha</span>
</pre></div>
</div>
<p>File nomenclature has be as follows:</p>
<ul class="simple">
<li><p>The file name root of image and corresponding mask has to be the same</p></li>
<li><p>The image name has to end in <code class="docutils literal notranslate"><span class="pre">_prep.mha</span></code></p></li>
<li><p>The mask name must end in <code class="docutils literal notranslate"><span class="pre">_f.mha</span></code></p></li>
</ul>
<p>Create the input file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">./</span><span class="n">findReference</span>
<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">r</span> <span class="n">subject2_prep</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">m</span> <span class="n">subject1_prep</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="n">m</span> <span class="n">subject2_prep</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="n">m</span> <span class="n">subject3_prep</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="n">m</span> <span class="n">etc</span><span class="o">.</span>
</pre></div>
</div>
<p>where:</p>
<ul class="simple">
<li><p>Line 1: findReference folder, containing all the images of the dataset</p></li>
<li><p>Line 2: Reference image, indicated as <code class="docutils literal notranslate"><span class="pre">r</span></code></p></li>
<li><p>Line 3-5: Moving images, indicated as <code class="docutils literal notranslate"><span class="pre">m</span></code></p></li>
</ul>
<p>Note that in this example <code class="docutils literal notranslate"><span class="pre">subject2_prep.mha</span></code> is both the reference and an image of the dataset, because we want to include it as a possible candidate for being the final reference</p>
<p>If you run multiple studies, created the input file for every seed image, adapting the reference (<code class="docutils literal notranslate"><span class="pre">r</span></code>) file name</p>
</div>
<div class="section" id="executing-findreference-ipynb">
<h3>Executing findReference.ipynb<a class="headerlink" href="#executing-findreference-ipynb" title="Permalink to this headline">¶</a></h3>
<p>For each seed image, in <code class="docutils literal notranslate"><span class="pre">findReference.ipynb</span></code> customize <code class="docutils literal notranslate"><span class="pre">input_file_name</span></code> and <code class="docutils literal notranslate"><span class="pre">n_of_cores</span></code></p>
<p>Launch <code class="docutils literal notranslate"><span class="pre">findReference.ipynb</span></code>. It will run until convergence or until the number of iterations reaches 10 (If you run the source code, you can change the number of iterations in the file <code class="docutils literal notranslate"><span class="pre">find_reference_for_nb.py</span></code>, function <code class="docutils literal notranslate"><span class="pre">find_reference</span></code>, variable <code class="docutils literal notranslate"><span class="pre">maxIterationNo</span></code>)</p>
</div>
<div class="section" id="output-convergence-plot">
<h3>Output: Convergence plot<a class="headerlink" href="#output-convergence-plot" title="Permalink to this headline">¶</a></h3>
<p>The output of the computation is a convergence plot. The graph can reach a plateau or can be zig-zagged. In this last case, choose the reference with the lowest error (y-axis). If the graph shows less than 10 iterations it means that the current reference image is the same as the one in the previous loop.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="segmentation-quality">
<span id="segmentationquality"></span><h2>Segmentation quality<a class="headerlink" href="#segmentation-quality" title="Permalink to this headline">¶</a></h2>
<p>You can quantify segmentation quality when a <strong>ground truth</strong> segmentation is present, whereas you can  evaluate segmentation quality only visually when a ground truth segmentation is not available</p>
<p>The metrics we use to evaluate segmentation quality are:</p>
<ul class="simple">
<li><p>Measures of overlap agreement: Dice coefficient, Jaccard coefficient, and volume similarity, which quantify the overlap between ground truth segmentations and <em>pyKNEEr</em> segmentations</p></li>
<li><p>Measure of surface distance: Average of the Euclidean distances between ground truth segmentations and <em>pyKNEEr</em> segmentations</p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div>The Jupyter notebook to evaluate segmentation is <a href="https://github.com/sbonaretti/pyKNEEr/blob/master/pykneer/notebooks/segmentation_quality.ipynb" target="_blank">segmentation_quality.ipynb</a></div></blockquote>
<div class="section" id="id6">
<h3>Input: Image list<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>Create the input file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">./</span><span class="n">segmented</span>
<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">./</span><span class="n">segmented_groundTruth</span>
<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">s</span> <span class="n">subject1_prep_fc</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="n">g</span> <span class="n">subject1_groundTruth_fc</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="n">s</span> <span class="n">subject2_prep_fc</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="n">g</span> <span class="n">subject2_groundTruth_fc</span><span class="o">.</span><span class="n">mha</span>
<span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="n">m</span> <span class="n">etc</span><span class="o">.</span>
</pre></div>
</div>
<p>where:</p>
<ul class="simple">
<li><p>Line 1: Segmented folder, containing the masks obtained with <em>pyKNEEr</em></p></li>
<li><p>Line 2: Ground truth folder, containing ground truth masks</p></li>
<li><p>Lines 3,5: Segmentations obtained with <em>pyKNEEr</em>, indicated as <code class="docutils literal notranslate"><span class="pre">s</span></code></p></li>
<li><p>Lines 4,6: Ground truth segmentations, indicated as <code class="docutils literal notranslate"><span class="pre">g</span></code></p></li>
</ul>
</div>
<div class="section" id="id7">
<h3>Execution, Output, and Visualization<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>Execution:</p>
<ul class="simple">
<li><p>In <code class="docutils literal notranslate"><span class="pre">segmentation_quality.ipynb</span></code>, customize <code class="docutils literal notranslate"><span class="pre">input_file_name</span></code>, <code class="docutils literal notranslate"><span class="pre">output_file_name_overlap</span></code>, and <code class="docutils literal notranslate"><span class="pre">output_file_name_distances</span></code>, and execute</p></li>
</ul>
<p>Output and visualization:</p>
<ul class="simple">
<li><p>Results will be visualized as graphs and tables, and will be saved in the <code class="docutils literal notranslate"><span class="pre">.csv</span></code> files for possible subsequent analysis</p></li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="references">
<h3>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h3>
[1] Klein S., Staring M., Murphy K., Viergever M.A., Pluim J.P.W.
<a href="http://elastix.isi.uu.nl/marius/downloads/2010_j_TMI.pdf" target="_blank">
<i>elastix: A Toolbox for Intensity-Based Medical Image Registration.</i></a>
IEEE Transactions on Medical Imaging. vol. 29, no. 1, pp. 196 - 205, January. 2010.</div>
</div>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="preprocessing.html" title="previous chapter (use the left arrow)">Preprocessing</a>
      </div>
    
      <div class="pull-right">
        <a class="btn btn-default" href="morphology.html" title="next chapter (use the right arrow)">Morphology</a>
      </div>
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="morphology.html" title="Morphology"
             >next</a> |</li>
        <li class="right" >
          <a href="preprocessing.html" title="Preprocessing"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pyKNEEr 1.0.0 documentation</a> &#187;</li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="_static/js/bootstrap.js"></script>
  <div class="footer">
    &copy; Copyright 2018, Serena Bonaretti. Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-135735296-1']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>